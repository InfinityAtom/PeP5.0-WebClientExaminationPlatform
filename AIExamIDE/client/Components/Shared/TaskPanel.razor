@implements IDisposable
@inject ExamState ExamState
@inject ApiClient ApiClient
@inject IJSRuntime JSRuntime

<style>
.timer-box {
    padding: 6px 16px;
    border-radius: 16px;
    font-weight: 700;
    font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, "Liberation Mono", monospace;
    letter-spacing: 0.8px;
    box-shadow: 
        0 0 0 1px var(--mud-palette-lines-default) inset,
        0 2px 8px rgba(0, 0, 0, 0.08),
        0 1px 3px rgba(0, 0, 0, 0.12);
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(8px);
}

.timer-box::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
    pointer-events: none;
}

.timer-box:hover {
    transform: translateY(-1px);
    box-shadow: 
        0 0 0 1px var(--mud-palette-lines-default) inset,
        0 4px 16px rgba(0, 0, 0, 0.12),
        0 2px 6px rgba(0, 0, 0, 0.16);
}

.timer-text {
    font-size: 1.4rem;
    line-height: 1.1;
    position: relative;
    z-index: 1;
    color: white;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

.timer-ok {
    background: linear-gradient(135deg, var(--mud-palette-success) 0%, color-mix(in oklab, var(--mud-palette-success) 85%, black) 100%);
    color: white;
    border: 1px solid color-mix(in oklab, var(--mud-palette-success) 80%, white);
}

.timer-warn {
    background: linear-gradient(135deg, var(--mud-palette-warning) 0%, color-mix(in oklab, var(--mud-palette-warning) 90%, black) 100%);
    color: white;
    box-shadow: 
        0 0 0 2px color-mix(in oklab, var(--mud-palette-warning) 45%, transparent) inset,
        0 2px 8px rgba(0, 0, 0, 0.08),
        0 1px 3px rgba(0, 0, 0, 0.12),
        0 0 20px color-mix(in oklab, var(--mud-palette-warning) 30%, transparent);
    border: 1px solid color-mix(in oklab, var(--mud-palette-warning) 70%, white);
}

.timer-crit {
    background: linear-gradient(135deg, var(--mud-palette-error) 0%, color-mix(in oklab, var(--mud-palette-error) 85%, black) 100%);
    color: white;
    border: 1px solid color-mix(in oklab, var(--mud-palette-error) 80%, white);
    box-shadow: 
        0 0 0 1px var(--mud-palette-error) inset,
        0 2px 8px rgba(0, 0, 0, 0.08),
        0 1px 3px rgba(0, 0, 0, 0.12),
        0 0 25px color-mix(in oklab, var(--mud-palette-error) 40%, transparent);
}

.timer-pulse {
    animation: timer-pulse 1200ms cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

.timer-crit.timer-pulse {
    animation: timer-pulse-urgent 800ms cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite;
}

@@keyframes timer-pulse {
    0% { 
        transform: scale(1);
        filter: brightness(1);
    }
    50% { 
        transform: scale(1.04);
        filter: brightness(1.1);
    }
    100% { 
        transform: scale(1);
        filter: brightness(1);
    }
}

@@keyframes timer-pulse-urgent {
    0% { 
        transform: scale(1);
        filter: brightness(1) saturate(1);
        box-shadow: 
            0 0 0 1px var(--mud-palette-error) inset,
            0 2px 8px rgba(0, 0, 0, 0.08),
            0 1px 3px rgba(0, 0, 0, 0.12),
            0 0 25px color-mix(in oklab, var(--mud-palette-error) 40%, transparent);
    }
    50% { 
        transform: scale(1.08);
        filter: brightness(1.15) saturate(1.2);
        box-shadow: 
            0 0 0 2px var(--mud-palette-error) inset,
            0 4px 16px rgba(0, 0, 0, 0.15),
            0 2px 6px rgba(0, 0, 0, 0.2),
            0 0 35px color-mix(in oklab, var(--mud-palette-error) 60%, transparent);
    }
    100% { 
        transform: scale(1);
        filter: brightness(1) saturate(1);
        box-shadow: 
            0 0 0 1px var(--mud-palette-error) inset,
            0 2px 8px rgba(0, 0, 0, 0.08),
            0 1px 3px rgba(0, 0, 0, 0.12),
            0 0 25px color-mix(in oklab, var(--mud-palette-error) 40%, transparent);
    }
}

/* Optional: Add a subtle loading state */
.timer-loading {
    position: relative;
    overflow: hidden;
}

.timer-loading::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    animation: timer-shimmer 2s infinite;
}

@@keyframes timer-shimmer {
    0% { left: -100%; }
    100% { left: 100%; }
}
</style>

<MudPaper Square="true" Elevation="0">
    <MudStack  Spacing="0">
        <!-- Header sticky -->
        <MudPaper Elevation="0"
                  Class="px-4 py-3"
                  Style="position:sticky;top:0;z-index:1;background:var(--mud-palette-background);border-bottom:1px solid var(--mud-palette-lines-default);">
            <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudText Typo="Typo.h6" Class="font-weight-bold">Tasks</MudText>

                <!-- TIMER (not a MudChip) -->
                <MudPaper Elevation="1"
                          Class="@GetTimerBoxClass()"
                          Role="status"
                          AriaLabel="Time remaining">
                    <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.Timer" />
                        <MudText Class="timer-text">@FormatTime(ExamState.TimeRemainingSeconds)</MudText>
                    </MudStack>
                </MudPaper>
            </MudStack>
        </MudPaper>

        <!-- Scrollable content -->
        <MudScrollArea Class="px-4 py-3" Style="height:100%;min-height:0;">
            @if (ExamState.CurrentExam != null)
            {
                <!-- Current Task -->
                <MudCard Class="mb-3" Elevation="1" Dense="true">
                    <MudCardHeader DisableTypography="true">
                        <CardHeaderContent>
                            <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.subtitle1" Class="font-weight-bold">
                                    Task @(ExamState.CurrentTaskIndex + 1) / @ExamState.CurrentExam.Tasks.Count
                                </MudText>
                                <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Text">
                                    @GetTaskProgress()
                                </MudChip>
                            </MudStack>
                        </CardHeaderContent>
                    </MudCardHeader>

                    <MudDivider />

                    <MudCardContent Class="py-2">
                        @if (CurrentTask != null)
                        {
                            <MudText Typo="Typo.subtitle2" Class="font-weight-medium mb-1">@CurrentTask.Title</MudText>
                            <MudText Typo="Typo.body2" Class="text-secondary">@CurrentTask.Description</MudText>
                        }
                    </MudCardContent>

                    <MudCardActions Class="px-3 pb-3 pt-0">
                        <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="w-100">
                            <MudButton StartIcon="@Icons.Material.Filled.ArrowBack"
                                       Variant="Variant.Outlined"
                                       Size="Size.Small"
                                       OnClick="PreviousTask"
                                       Disabled="@(ExamState.CurrentTaskIndex == 0)">
                                Previous
                            </MudButton>

                            <MudButton EndIcon="@Icons.Material.Filled.ArrowForward"
                                       Variant="Variant.Outlined"
                                       Color="Color.Primary"
                                       Size="Size.Small"
                                       OnClick="NextTask"
                                       Disabled="@(ExamState.CurrentTaskIndex >= ExamState.CurrentExam.Tasks.Count - 1)">
                                Next
                            </MudButton>
                        </MudStack>
                    </MudCardActions>
                </MudCard>

                <!-- CSV Data Files -->
                @if (GetCsvFiles().Any())
                {
                    <MudCard Class="mb-3" Elevation="1" Dense="true">
                        <MudCardHeader DisableTypography="true">
                            <CardHeaderContent>
                                <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                    <MudIcon Icon="@Icons.Material.Filled.TableChart" Color="Color.Warning" />
                                    <MudText Typo="Typo.subtitle1" Class="font-weight-medium">CSV Data Files</MudText>
                                    <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Text">
                                        @GetCsvFiles().Count file(s)
                                    </MudChip>
                                </MudStack>
                            </CardHeaderContent>
                        </MudCardHeader>

                        <MudDivider />

                        <MudCardContent Class="py-2">
                            <MudStack Spacing="1">
                                @foreach (var csvFile in GetCsvFiles())
                                {
                                    <MudPaper Class="pa-2" Elevation="0" Style="border-left:4px solid var(--mud-palette-warning);">
                                        <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                                <MudIcon Icon="@Icons.Material.Filled.TableChart" Size="Size.Small" />
                                                <MudText Typo="Typo.body2" Class="font-weight-medium">@csvFile.Name</MudText>
                                            </MudStack>

                                            <MudStack Row Spacing="1">
                                                <MudButton StartIcon="@Icons.Material.Filled.Visibility"
                                                           Size="Size.Small"
                                                           Variant="Variant.Filled"
                                                           Color="Color.Info"
                                                           OnClick="() => ShowCsvOverlay(csvFile)">
                                                    View
                                                </MudButton>
                                                <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                                                               Size="Size.Small"
                                                               Color="Color.Secondary"
                                                               AriaLabel="Copy path"
                                                               OnClick="() => CopyPath(csvFile.Path)" />
                                            </MudStack>
                                        </MudStack>
                                    </MudPaper>
                                }
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                }

                <!-- Run Configuration -->
                @if (ExamState.GetRunnableFiles().Any())
                {
                    <MudCard Class="mb-3" Elevation="1" Dense="true">
                        <MudCardHeader DisableTypography="true">
                            <CardHeaderContent>
                                <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                    <MudIcon Icon="@Icons.Material.Filled.PlayArrow" Color="Color.Success" />
                                    <MudText Typo="Typo.subtitle1" Class="font-weight-medium">Run Configuration</MudText>
                                </MudStack>
                            </CardHeaderContent>
                        </MudCardHeader>

                        <MudDivider />

                        <MudCardContent Class="py-2">
                            <MudStack Spacing="2">
                                @if (ExamState.ActiveFile != null && ExamState.HasMainMethod(ExamState.ActiveFile))
                                {
                                    <MudAlert Severity="Severity.Success" Dense="true">
                                        <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                            <MudText Typo="Typo.body2">
                                                Current File:
                                                <MudText Typo="Typo.body2" Class="font-weight-bold d-inline"> @ExamState.ActiveFile.Name </MudText>
                                                has main()
                                            </MudText>
                                        </MudStack>
                                    </MudAlert>
                                }

                                <MudSelect @bind-Value="selectedRunFile"
                                           Variant="Variant.Outlined"
                                           Dense="true"
                                           >
                                    <MudSelectItem Value="@("")">Auto detect</MudSelectItem>
                                    @foreach (var file in ExamState.GetRunnableFiles())
                                    {
                                        <MudSelectItem Value="@file.Path">
                                            <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                                                <MudIcon Icon="@Icons.Custom.FileFormats.FileCode" Size="Size.Small" />
                                                <MudText Typo="Typo.body2">@file.Name</MudText>
                                            </MudStack>
                                        </MudSelectItem>
                                    }
                                </MudSelect>

                                <MudText Typo="Typo.caption" Class="text-secondary">
                                    <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-1" />
                                    Will run:
                                    <MudText Typo="Typo.caption" Class="font-weight-bold d-inline"> @GetAutoDetectedFile() </MudText>
                                </MudText>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                }

                <!-- Actions -->
                <MudCard Class="mb-3" Elevation="1" Dense="true">
                    <MudCardHeader DisableTypography="true">
                        <CardHeaderContent>
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.Settings" />
                                <MudText Typo="Typo.subtitle1" Class="font-weight-medium">Actions</MudText>
                            </MudStack>
                        </CardHeaderContent>
                    </MudCardHeader>

                    <MudDivider />

                    <MudCardContent Class="py-2">
                        <MudStack Spacing="1">
                            <MudButton StartIcon="@Icons.Material.Filled.PlayArrow"
                                       Variant="Variant.Filled"
                                       Color="Color.Success"
                                       FullWidth="true"
                                       Size="Size.Medium"
                                       OnClick="RunCode"
                                       Disabled="@(isRunning || !HasRunnableFile() || ExamState.IsSubmitted)">
                                @if (isRunning)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                    <span>Running...</span>
                                }
                                else
                                {
                                    <span>Run @GetRunButtonText()</span>
                                }
                            </MudButton>

                            <MudButton StartIcon="@Icons.Material.Filled.Refresh"
                                       Variant="Variant.Filled"
                                       Color="Color.Warning"
                                       FullWidth="true"
                                       OnClick="ResetCode"
                                       Disabled="@ExamState.IsSubmitted">
                                Reset All Files
                            </MudButton>

                            <MudButton StartIcon="@Icons.Material.Filled.Send"
                                       Variant="Variant.Filled"
                                       Color="Color.Error"
                                       FullWidth="true"
                                       OnClick="SubmitExam"
                                       Disabled="@ExamState.IsSubmitted">
                                Submit Exam
                            </MudButton>
                        </MudStack>
                    </MudCardContent>
                </MudCard>

                <!-- Runnable Files -->
                <MudCard Elevation="1" Dense="true">
                    <MudCardHeader DisableTypography="true">
                        <CardHeaderContent>
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Custom.FileFormats.FileCode" Color="Color.Info" />
                                <MudText Typo="Typo.subtitle1" Class="font-weight-medium">Runnable Files</MudText>
                                <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Text">
                                    @ExamState.GetRunnableFiles().Count() file(s)
                                </MudChip>
                            </MudStack>
                        </CardHeaderContent>
                    </MudCardHeader>

                    <MudDivider />

                    <MudCardContent Class="py-2">
                        @if (ExamState.GetRunnableFiles().Any())
                        {
                            <MudStack Spacing="1">
                                @foreach (var file in ExamState.GetRunnableFiles())
                                {
                                    <MudPaper Class="pa-2" Elevation="0" Style="border-left:4px solid var(--mud-palette-info);">
                                        <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                            <MudButton StartIcon="@Icons.Custom.FileFormats.FileCode"
                                                       Variant="Variant.Text"
                                                       Size="Size.Small"
                                                       OnClick="() => ExamState.OpenFile(file)">
                                                @file.Name
                                            </MudButton>
                                            <MudIconButton Icon="@Icons.Material.Filled.PlayArrow"
                                                           Size="Size.Small"
                                                           Color="Color.Success"
                                                           AriaLabel="Run this file"
                                                           OnClick="() => RunSpecificFile(file)"
                                                           Disabled="@ExamState.IsSubmitted" />
                                        </MudStack>
                                    </MudPaper>
                                }
                            </MudStack>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info" Dense="true">
                                <MudText>No runnable files found. Create a Java file with a main() method.</MudText>
                            </MudAlert>
                        }
                    </MudCardContent>
                </MudCard>
            }
        </MudScrollArea>
    </MudStack>
</MudPaper>

@code {
    private bool isRunning = false;
    private string selectedRunFile = "";
    private bool _disposed = false;
    private ExamTask? CurrentTask => ExamState.CurrentExam?.Tasks.ElementAtOrDefault(ExamState.CurrentTaskIndex);

    protected override void OnInitialized()
    {
        ExamState.OnChange += StateHasChanged;
    }

    private List<ExamFile> GetCsvFiles()
    {
        return ExamState.Files.Where(f => !f.IsDirectory && f.Name.EndsWith(".csv")).ToList();
    }

    private string GetTaskProgress()
    {
        if (ExamState.CurrentExam == null) return "0%";
        var progress = ((ExamState.CurrentTaskIndex + 1) * 100) / ExamState.CurrentExam.Tasks.Count;
        return $"{progress}%";
    }

    private string GetTimerBoxClass()
    {
        if (ExamState.TimeRemainingSeconds <= 60)
            return "timer-box timer-crit timer-pulse";
        if (ExamState.TimeRemainingSeconds <= 300)
            return "timer-box timer-warn";
        return "timer-box timer-ok";
    }

    private void ShowCsvOverlay(ExamFile csvFile)
    {
        ExamState.ShowCsvOverlay(csvFile);
    }

    private async Task CopyPath(string path)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", path);
            Console.WriteLine($"Path copied to clipboard: {path}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to copy path: {ex.Message}");
        }
    }

    private bool HasRunnableFile() => ExamState.GetRunnableFiles().Any();

    private string GetAutoDetectedFile()
    {
        if (ExamState.ActiveFile != null && ExamState.HasMainMethod(ExamState.ActiveFile))
            return ExamState.ActiveFile.Name;

        var mainJava = ExamState.GetFileByPath("src/Main.java");
        if (mainJava != null && ExamState.HasMainMethod(mainJava))
            return "Main.java";

        var firstRunnable = ExamState.GetRunnableFiles().FirstOrDefault();
        return firstRunnable?.Name ?? "None";
    }

    private string GetRunButtonText()
    {
        if (!string.IsNullOrEmpty(selectedRunFile))
        {
            var file = ExamState.GetFileByPath(selectedRunFile);
            return file?.Name ?? "File";
        }
        return GetAutoDetectedFile();
    }

    private async Task RunCode()
    {
        if (_disposed) return;
        ExamState.NotifyCodeRunStarted();
        isRunning = true;
        StateHasChanged();

        try
        {
            await Task.Delay(100);
            var files = ExamState.GetAllFiles();
            var mainFile = GetFileToRun();

            if (mainFile == null)
            {
                ExamState.SetConsoleOutput("Error: No runnable file found. Make sure your Java file has a main() method.");
                return;
            }

            Console.WriteLine($"ðŸš€ Running {mainFile.Name} with content length: {mainFile.Content.Length}");

            var result = await ApiClient.RunCodeAsync(files, mainFile.Path);

            var output = !string.IsNullOrEmpty(result.Error)
                ? $"=== Running {mainFile.Name} ===\n\nError:\n{result.Error}"
                : $"=== Running {mainFile.Name} ===\n\nOutput:\n{result.Output}";

            ExamState.SetConsoleOutput(output);
        }
        catch (Exception ex)
        {
            ExamState.SetConsoleOutput($"Error: {ex.Message}");
        }
        finally
        {
            isRunning = false;
            if (!_disposed) StateHasChanged();
        }
    }

    private async Task RunSpecificFile(ExamFile file)
    {
        selectedRunFile = file.Path;
        await RunCode();
    }

    private ExamFile? GetFileToRun()
    {
        if (!string.IsNullOrEmpty(selectedRunFile))
            return ExamState.GetFileByPath(selectedRunFile);

        if (ExamState.ActiveFile != null && ExamState.HasMainMethod(ExamState.ActiveFile))
            return ExamState.ActiveFile;

        var mainJava = ExamState.GetFileByPath("src/Main.java");
        if (mainJava != null && ExamState.HasMainMethod(mainJava))
            return mainJava;

        return ExamState.GetRunnableFiles().FirstOrDefault();
    }

    private async Task ResetCode()
    {
        if (_disposed) return;

        try
        {
            await ApiClient.ResetExamAsync();
            var examData = await ApiClient.GenerateExamAsync();
            ExamState.LoadExam(examData.Exam, examData.Files);
            ExamState.SetConsoleOutput("All files reset to initial state.");
        }
        catch (Exception ex)
        {
            ExamState.SetConsoleOutput($"Reset failed: {ex.Message}");
        }
    }

    private async Task SubmitExam()
    {
        if (_disposed) return;

        try
        {
            var files = ExamState.GetAllFiles();
            await ApiClient.SubmitExamAsync(files);
            ExamState.MarkAsSubmitted();
            ExamState.SetConsoleOutput("Exam submitted successfully!");
        }
        catch (Exception ex)
        {
            ExamState.SetConsoleOutput($"Submit failed: {ex.Message}");
        }
    }

    private void PreviousTask()
    {
        if (_disposed) return;
        if (ExamState.CurrentTaskIndex > 0)
        {
            ExamState.CurrentTaskIndex--;
            StateHasChanged();
        }
    }

    private void NextTask()
    {
        if (_disposed) return;
        if (ExamState.CurrentExam != null && ExamState.CurrentTaskIndex < ExamState.CurrentExam.Tasks.Count - 1)
        {
            ExamState.CurrentTaskIndex++;
            StateHasChanged();
        }
    }

    private string FormatTime(int seconds)
    {
        var timeSpan = TimeSpan.FromSeconds(seconds);
        return $"{timeSpan.Hours:D2}:{timeSpan.Minutes:D2}:{timeSpan.Seconds:D2}";
    }

    public void Dispose()
    {
        if (!_disposed)
        {
            _disposed = true;
            if (ExamState != null)
            {
                ExamState.OnChange -= StateHasChanged;
            }
        }
    }
}
